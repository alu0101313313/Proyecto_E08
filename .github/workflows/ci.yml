name: CI Pipeline (Vitest & Selenium)

on:
  push:
    branches: ['**']
  pull_request:
    branches: [dev]

jobs:
  # --- JOB 1: TEST BACKEND (Unitarios) ---
  backend-tests:
    name: Backend Unit Tests
    runs-on: ubuntu-latest
    
    # Servicio MongoDB temporal para que el backend pueda conectarse
    services:
      mongodb:
        image: mongo:6.0
        ports:
          - 27017:27017
          
    env:
      MONGODB_URI: mongodb://localhost:27017/test_db 
      JWT_SECRET: "secreto_temporal_para_ci"
    
    defaults:
      run:
        working-directory: ./server
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v1
      - run: bun install
      - run: bun run test

  # --- JOB 2: TEST E2E (Frontend + Backend Integration) ---
  e2e-tests:
    name: E2E Selenium Tests
    runs-on: ubuntu-latest
    
    # Servicio MongoDB temporal también para los tests E2E
    services:
      mongodb:
        image: mongo:6.0
        ports:
          - 27017:27017

    env:
      MONGODB_URI: mongodb://localhost:27017/e2e_db
      JWT_SECRET: "secreto_temporal_para_ci"
      PORT: 5000
    
    steps:
      - name: Checkout del código
        uses: actions/checkout@v4

      - name: Instalar Bun
        uses: oven-sh/setup-bun@v1

      # 1. Instalar dependencias (Server y Client)
      - name: Instalar Dependencias
        run: |
          cd server && bun install
          cd ../client && bun install

      # 2. CONSTRUIR EL FRONTEND (Build) 
      # Esto es vital para detectar errores de compilación y para que arranque rápido
      - name: Build Frontend
        working-directory: ./client
        run: bun run build

      # 3. Arrancar Servidores y Ejecutar Tests
      - name: Start Servers & Run Selenium
        run: |
          # Arrancar Backend (en segundo plano)
          cd server
          nohup bun run dev > ../backend.log 2>&1 &
          echo "Backend iniciando..."
          
          # Arrancar Frontend en modo PRODUCCIÓN (mucho más rápido que dev)
          cd ../client
          nohup bun run start > ../frontend.log 2>&1 &
          echo "Frontend iniciando..."
          
          # Instalar herramientas de test (si no están en package.json)
          npm install selenium-webdriver chromedriver mocha wait-on
          
          # Esperar a que los puertos 3000 (front) y 5000 (back) respondan
          echo "Esperando a que los servidores estén listos..."
          npx wait-on http://localhost:3000 http://localhost:5000 --timeout 120000
          
          echo "¡Sistemas listos! Ejecutando Selenium..."
          npx mocha tests/wishlistandlogin20.spec.js --timeout 60000

      # 4. Mostrar logs si algo falla (Para debuggear)
      - name: Show Logs on Failure
        if: failure()
        run: |
          echo "=== LOGS DEL BACKEND ==="
          cat backend.log
          echo ""
          echo "=== LOGS DEL FRONTEND ==="
          cat frontend.log